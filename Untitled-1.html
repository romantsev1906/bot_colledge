<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ñ–µ—Ç–æ–Ω—á–∏–∫–∏ - –£—á–µ–±–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 {
            font-size: 20px;
            margin-bottom: 5px;
        }
        .role-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
        }
        .menu {
            padding: 20px;
        }
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .btn {
            background: #4facfe;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }
        .btn:hover {
            background: #00f2fe;
            transform: translateY(-2px);
        }
        .btn.admin { background: #ff6b6b; }
        .btn.admin:hover { background: #ff5252; }
        .btn.teacher { background: #4ecdc4; }
        .btn.teacher:hover { background: #45b7aa; }
        .btn.student { background: #ffe66d; color: #333; }
        .btn.student:hover { background: #ffed4e; }
        .section {
            display: none;
            padding: 20px;
            border-top: 1px solid #eee;
        }
        .section.active { display: block; }
        .list-item {
            background: #f8f9fa;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
        }
        .grade-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .grade-mark {
            font-weight: bold;
            font-size: 18px;
            min-width: 30px;
            text-align: center;
        }
        .grade-mark.n { color: #999; }
        .grade-mark.fail { color: #ff6b6b; }
        .grade-mark.pass { color: #4ecdc4; }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4facfe;
        }
        .token-balance {
            background: linear-gradient(135deg, #ffe66d 0%, #ffed4e 100%);
            color: #333;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin: 15px 0;
        }
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e1e5e9;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: #4ecdc4;
            transition: width 0.3s;
        }
        .ktp-type { 
            background: #f0f8ff; 
            padding: 8px 12px; 
            border-radius: 20px; 
            font-size: 12px; 
            display: inline-block;
            margin: 2px;
        }
        .lecture { background: #fff3cd; color: #856404; }
        .practice { background: #d1ecf1; color: #0c5460; }
        .upload-area {
            border: 2px dashed #4facfe;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .upload-area:hover {
            background: #f0f8ff;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –®–∞–ø–∫–∞ -->
        <div class="header">
            <h1>üéì –ñ–µ—Ç–æ–Ω—á–∏–∫–∏</h1>
            <div class="role-badge" id="roleBadge">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
        <div id="mainMenu" class="menu">
            <div id="adminMenu" class="menu-grid" style="display:none;">
                <button class="btn admin" onclick="showSection('uploadTeachers')">üìö –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π</button>
                <button class="btn admin" onclick="showSection('generateTokens')">üé´ –¢–æ–∫–µ–Ω—ã –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π</button>
                <button class="btn admin" onclick="showSection('listTeachers')">üë®‚Äçüè´ –°–ø–∏—Å–æ–∫ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π</button>
                <button class="btn admin" onclick="showSection('listStudents')">üë®‚Äçüéì –°–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</button>
                <button class="btn admin" onclick="showSection('sendNews')">üì¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤–æ—Å—Ç—å</button>
                <button class="btn admin" onclick="downloadTemplate('teachers')">üìÑ –®–∞–±–ª–æ–Ω –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π</button>
            </div>

            <div id="teacherMenu" class="menu-grid" style="display:none;">
                <button class="btn teacher" onclick="showSection('addGroup')">üë• –î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É</button>
                <button class="btn teacher" onclick="showSection('addDiscipline')">üìñ –î–æ–±–∞–≤–∏—Ç—å –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É</button>
                <button class="btn teacher" onclick="showSection('myGroups')">üèòÔ∏è –ú–æ–∏ –≥—Ä—É–ø–ø—ã</button>
                <button class="btn teacher" onclick="showSection('myDisciplines')">üìö –ú–æ–∏ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã</button>
                <button class="btn teacher" onclick="showSection('createKtp')">‚ûï –°–æ–∑–¥–∞—Ç—å –ö–¢–ü</button>
                <button class="btn teacher" onclick="showSection('viewKtp')">üìã –ö–¢–ü</button>
                <button class="btn teacher" onclick="showSection('grade')">‚úèÔ∏è –í—ã—Å—Ç–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫–∏</button>
                <button class="btn teacher" onclick="showSection('editGrade')">üîÑ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="btn teacher" onclick="showSection('students')">üë®‚Äçüéì –°—Ç—É–¥–µ–Ω—Ç—ã</button>
                <button class="btn teacher" onclick="showSection('gradebook')">üìä –í–µ–¥–æ–º–æ—Å—Ç—å</button>
                <button class="btn teacher" onclick="showSection('rewards')">üéÅ –ù–∞–≥—Ä–∞–¥—ã</button>
                <button class="btn teacher" onclick="showSection('tokensPerAttendance')">üí∞ –ñ–µ—Ç–æ–Ω—ã –∑–∞ –ø–æ—Å–µ—â–µ–Ω–∏–µ</button>
                <button class="btn teacher" onclick="showSection('sendGroupNews')">üì¢ –ù–æ–≤–æ—Å—Ç—å –≥—Ä—É–ø–ø–µ</button>
                <button class="btn teacher" onclick="downloadTemplate('students')">üìÑ –®–∞–±–ª–æ–Ω —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</button>
            </div>

            <div id="studentMenu" class="menu-grid" style="display:none;">
                <button class="btn student" onclick="showSection('grades')">üìã –ú–æ–∏ –æ—Ü–µ–Ω–∫–∏</button>
                <button class="btn student" onclick="showSection('teachers')">üë®‚Äçüè´ –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏</button>
                <button class="btn student" onclick="showSection('tokens')">üí∞ –ú–æ–∏ –∂–µ—Ç–æ–Ω—ã</button>
                <button class="btn student" onclick="showSection('rewardsShop')">üéÅ –ú–∞–≥–∞–∑–∏–Ω</button>
                <button class="btn student" onclick="showSection('practices')">‚úÖ –ü—Ä–∞–∫—Ç–∏–∫–∏</button>
                <button class="btn student" onclick="exportGrades()">üìÑ –≠–∫—Å–ø–æ—Ä—Ç –æ—Ü–µ–Ω–æ–∫</button>
            </div>
        </div>

        <!-- –°–ï–ö–¶–ò–ò -->
        
        <!-- –ê–¥–º–∏–Ω: –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π -->
        <div id="uploadTeachers" class="section">
            <h3>üìö –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π</h3>
            <div class="upload-area" onclick="document.getElementById('teachersFile').click()">
                <p>üìÅ –ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ Excel —Ñ–∞–π–ª</p>
                <small>–ö–æ–ª–æ–Ω–∫–∞: "–§–ò–û –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è"</small>
            </div>
            <input type="file" id="teachersFile" accept=".xlsx" style="display:none;" onchange="uploadTeachers()">
        </div>

        <!-- –ê–¥–º–∏–Ω: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤ -->
        <div id="generateTokens" class="section">
            <h3>üé´ –¢–æ–∫–µ–Ω—ã –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π</h3>
            <button class="btn admin" onclick="generateTokens()">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ —Å–∫–∞—á–∞—Ç—å</button>
        </div>

        <!-- –ê–¥–º–∏–Ω: –°–ø–∏—Å–æ–∫ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π -->
        <div id="listTeachers" class="section">
            <h3>üë®‚Äçüè´ –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏</h3>
            <div id="teachersList" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <!-- –ê–¥–º–∏–Ω: –°–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ -->
        <div id="listStudents" class="section">
            <h3>üë®‚Äçüéì –°—Ç—É–¥–µ–Ω—Ç—ã</h3>
            <div id="studentsList" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <!-- –ê–¥–º–∏–Ω: –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–æ—Å—Ç–∏ -->
        <div id="sendNews" class="section">
            <h3>üì¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤–æ—Å—Ç—å</h3>
            <select id="newsRecipient">
                <option value="students">–°—Ç—É–¥–µ–Ω—Ç—ã</option>
                <option value="teachers">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏</option>
                <option value="all">–í—Å–µ</option>
            </select>
            <textarea id="newsText" placeholder="–¢–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏..." rows="4"></textarea>
            <button class="btn admin" onclick="sendNews()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>

        <!-- –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å: –î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É -->
        <div id="addGroup" class="section">
            <h3>üë• –î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É</h3>
            <div class="upload-area" onclick="document.getElementById('groupFile').click()">
                <p>üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</p>
            </div>
            <input type="file" id="groupFile" accept=".xlsx" style="display:none;" onchange="uploadGroup()">
            <input type="text" id="groupName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
            <button class="btn teacher" onclick="saveGroup()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≥—Ä—É–ø–ø—É</button>
        </div>

        <!-- –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å: –î–æ–±–∞–≤–∏—Ç—å –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É -->
        <div id="addDiscipline" class="section">
            <h3>üìñ –î–æ–±–∞–≤–∏—Ç—å –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É</h3>
            <input type="text" id="disciplineName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã">
            <input type="number" id="requiredPractices" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∞–∫—Ç–∏–∫" min="0">
            <select id="disciplineGroup"></select>
            <button class="btn teacher" onclick="saveDiscipline()">–°–æ–∑–¥–∞—Ç—å</button>
        </div>

        <!-- –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å: –ú–æ–∏ –≥—Ä—É–ø–ø—ã -->
        <div id="myGroups" class="section">
            <h3>üèòÔ∏è –ú–æ–∏ –≥—Ä—É–ø–ø—ã</h3>
            <div id="groupsList"></div>
        </div>

        <!-- –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å: –ú–æ–∏ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã -->
        <div id="myDisciplines" class="section">
            <h3>üìö –ú–æ–∏ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã</h3>
            <div id="disciplinesList"></div>
        </div>

        <!-- –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å: –°–æ–∑–¥–∞—Ç—å –ö–¢–ü -->
        <div id="createKtp" class="section">
            <h3>‚ûï –°–æ–∑–¥–∞—Ç—å –ö–¢–ü</h3>
            <select id="ktpDiscipline"></select>
            <select id="ktpType">
                <option value="lecture">–õ–µ–∫—Ü–∏—è</option>
                <option value="practice">–ü—Ä–∞–∫—Ç–∏–∫–∞</option>
            </select>
            <input type="number" id="practiceNumber" placeholder="‚Ññ –ø—Ä–∞–∫—Ç–∏–∫–∏ (–¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫)" min="1" max="20">
            <textarea id="ktpDescription" placeholder="–¢–µ–º–∞/–æ–ø–∏—Å–∞–Ω–∏–µ"></textarea>
            <textarea id="ktpHomework" placeholder="–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ (–∏–ª–∏ '–Ω–µ—Ç')"></textarea>
            <button class="btn teacher" onclick="createKtp()">–°–æ–∑–¥–∞—Ç—å –ö–¢–ü</button>
        </div>

        <!-- –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å: –ü—Ä–æ—Å–º–æ—Ç—Ä –ö–¢–ü -->
        <div id="viewKtp" class="section">
            <h3>üìã –ö–¢–ü</h3>
            <select id="viewKtpDiscipline"></select>
            <div id="ktpList"></div>
        </div>

        <!-- –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å: –í—ã—Å—Ç–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫–∏ -->
        <div id="grade" class="section">
            <h3>‚úèÔ∏è –í—ã—Å—Ç–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫–∏</h3>
            <select id="gradeDiscipline"></select>
            <select id="gradeKtpType">
                <option value="lecture">–õ–µ–∫—Ü–∏—è</option>
                <option value="practice">–ü—Ä–∞–∫—Ç–∏–∫–∞</option>
            </select>
            <select id="gradeKtp"></select>
            <input type="date" id="gradeDate">
            <button class="btn teacher" onclick="startGrading()">–ù–∞—á–∞—Ç—å –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏–µ</button>
            <div id="gradingForm" style="display:none;">
                <select id="gradingStudent"></select>
                <select id="gradeValue">
                    <option value="-1">–Ω</option>
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                </select>
                <button class="btn teacher" onclick="saveGrade()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>

        <!-- –°—Ç—É–¥–µ–Ω—Ç: –û—Ü–µ–Ω–∫–∏ -->
        <div id="grades" class="section">
            <h3>üìã –ú–æ–∏ –æ—Ü–µ–Ω–∫–∏</h3>
            <div id="studentGrades"></div>
        </div>

        <!-- –°—Ç—É–¥–µ–Ω—Ç: –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏ -->
        <div id="teachers" class="section">
            <h3>üë®‚Äçüè´ –ú–æ–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏</h3>
            <div id="studentTeachers"></div>
        </div>

        <!-- –°—Ç—É–¥–µ–Ω—Ç: –ñ–µ—Ç–æ–Ω—ã -->
        <div id="tokens" class="section">
            <h3>üí∞ –ú–æ–∏ –∂–µ—Ç–æ–Ω—ã</h3>
            <div id="studentTokens"></div>
        </div>

        <!-- –°—Ç—É–¥–µ–Ω—Ç: –ú–∞–≥–∞–∑–∏–Ω -->
        <div id="rewardsShop" class="section">
            <h3>üéÅ –ú–∞–≥–∞–∑–∏–Ω –Ω–∞–≥—Ä–∞–¥</h3>
            <div id="shopRewards"></div>
        </div>

        <!-- –°—Ç—É–¥–µ–Ω—Ç: –ü—Ä–∞–∫—Ç–∏–∫–∏ -->
        <div id="practices" class="section">
            <h3>‚úÖ –ú–æ–∏ –ø—Ä–∞–∫—Ç–∏–∫–∏</h3>
            <div id="studentPractices"></div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.MainButton.setText('–û–±–Ω–æ–≤–∏—Ç—å').show().onClick(refreshData);

        let userRole = '';
        let userData = {};

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            tg.ready();
            await loadUserData();
            showMenu();
            refreshData();
        }

        async function loadUserData() {
            try {
                const response = await fetch('/api/user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: tg.initDataUnsafe.user.id })
                });
                userData = await response.json();
                userRole = userData.role;
                document.getElementById('roleBadge').textContent = 
                    userRole === 'admin' ? 'üëë –ê–î–ú–ò–ù' :
                    userRole === 'teacher' ? 'üë®‚Äçüè´ –ü–†–ï–ü–û–î–ê–í–ê–¢–ï–õ–¨' : 'üë®‚Äçüéì –°–¢–£–î–ï–ù–¢';
            } catch(e) {
                document.getElementById('roleBadge').textContent = '–û—à–∏–±–∫–∞';
            }
        }

        function showMenu() {
            document.getElementById('adminMenu').style.display = userRole === 'admin' ? 'grid' : 'none';
            document.getElementById('teacherMenu').style.display = userRole === 'teacher' ? 'grid' : 'none';
            document.getElementById('studentMenu').style.display = userRole === 'student' ? 'grid' : 'none';
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            if (['addDiscipline', 'createKtp', 'grade'].includes(sectionId)) {
                loadSelectOptions(sectionId);
            }
        }

        async function refreshData() {
            tg.MainButton.setText('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...');
            switch(userRole) {
                case 'admin':
                    await Promise.all([loadTeachersList(), loadStudentsList()]);
                    break;
                case 'teacher':
                    await Promise.all([
                        loadGroupsList(), loadDisciplinesList(), 
                        loadKtpList(), loadGradeOptions()
                    ]);
                    break;
                case 'student':
                    await Promise.all([
                        loadStudentGrades(), loadStudentTeachers(), 
                        loadStudentTokens(), loadStudentPractices(), loadShopRewards()
                    ]);
                    break;
            }
            tg.MainButton.setText('–û–±–Ω–æ–≤–∏—Ç—å');
        }

        // –ê–î–ú–ò–ù –§–£–ù–ö–¶–ò–ò
        async function uploadTeachers() {
            const file = document.getElementById('teachersFile').files[0];
            if (!file) return showMessage('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª', 'error');
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('user_id', tg.initDataUnsafe.user.id);
            
            try {
                const response = await fetch('/api/upload_teachers', { method: 'POST', body: formData });
                const result = await response.json();
                showMessage(result.message, 'success');
            } catch(e) {
                showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
            }
        }

        async function generateTokens() {
            try {
                const response = await fetch('/api/generate_tokens', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: tg.initDataUnsafe.user.id })
                });
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'tokens.xlsx';
                a.click();
                showMessage('–¢–æ–∫–µ–Ω—ã —Å–∫–∞—á–∞–Ω—ã!', 'success');
            } catch(e) {
                showMessage('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏', 'error');
            }
        }

        async function loadTeachersList() {
            const response = await fetch('/api/teachers_list');
            const teachers = await response.json();
            document.getElementById('teachersList').innerHTML = 
                teachers.map(t => `<div class="list-item">${t.full_name}</div>`).join('');
        }

        async function loadStudentsList() {
            const response = await fetch('/api/students_list');
            const students = await response.json();
            document.getElementById('studentsList').innerHTML = 
                students.map(s => `<div class="list-item">${s.full_name} (${s.group_name})</div>`).join('');
        }

        async function sendNews() {
            const recipient = document.getElementById('newsRecipient').value;
            const text = document.getElementById('newsText').value.trim();
            if (!text) return showMessage('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç', 'error');
            
            try {
                await fetch('/api/send_news', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ recipient, text, user_id: tg.initDataUnsafe.user.id })
                });
                showMessage('–ù–æ–≤–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!', 'success');
                document.getElementById('newsText').value = '';
            } catch(e) {
                showMessage('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏', 'error');
            }
        }

        // –ü–†–ï–ü–û–î–ê–í–ê–¢–ï–õ–¨ –§–£–ù–ö–¶–ò–ò
        async function uploadGroup() {
            const file = document.getElementById('groupFile').files[0];
            if (!file) return;
            // –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ uploadTeachers
            showMessage('–ì—Ä—É–ø–ø–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!', 'success');
        }

        async function saveGroup() {
            const name = document.getElementById('groupName').value.trim();
            if (!name) return showMessage('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ', 'error');
            showMessage(`–ì—Ä—É–ø–ø–∞ "${name}" —Å–æ–∑–¥–∞–Ω–∞!`, 'success');
            document.getElementById('groupName').value = '';
        }

        async function loadSelectOptions(section) {
            if (section === 'addDiscipline') {
                const response = await fetch('/api/teacher_groups');
                const groups = await response.json();
                const select = document.getElementById('disciplineGroup');
                select.innerHTML = groups.map(g => `<option value="${g}">${g}</option>`).join('');
            }
            // –î—Ä—É–≥–∏–µ select...
        }

        async function saveDiscipline() {
            const name = document.getElementById('disciplineName').value;
            const practices = document.getElementById('requiredPractices').value;
            const group = document.getElementById('disciplineGroup').value;
            showMessage(`–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ "${name}" —Å–æ–∑–¥–∞–Ω–∞!`, 'success');
            document.getElementById('disciplineName').value = '';
        }

        async function loadGroupsList() {
            const response = await fetch('/api/teacher_groups');
            const groups = await response.json();
            document.getElementById('groupsList').innerHTML = 
                groups.map(g => `<div class="list-item">${g} <button class="btn" onclick="deleteGroup('${g}')">–£–¥–∞–ª–∏—Ç—å</button></div>`).join('');
        }

        async function loadDisciplinesList() {
            const response = await fetch('/api/teacher_disciplines');
            const disciplines = await response.json();
            document.getElementById('disciplinesList').innerHTML = 
                disciplines.map(d => `<div class="list-item">${d.name} (${d.group_name}) <button class="btn" onclick="deleteDiscipline(${d.id})">–£–¥–∞–ª–∏—Ç—å</button></div>`).join('');
        }

        async function createKtp() {
            // –õ–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ö–¢–ü
            showMessage('–ö–¢–ü —Å–æ–∑–¥–∞–Ω–æ!', 'success');
        }

        async function loadKtpList() {
            // –ó–∞–≥—Ä—É–∑–∫–∞ –ö–¢–ü
        }

        async function startGrading() {
            document.getElementById('gradingForm').style.display = 'block';
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –¥–ª—è select
        }

        async function saveGrade() {
            showMessage('–û—Ü–µ–Ω–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!', 'success');
        }

        // –°–¢–£–î–ï–ù–¢ –§–£–ù–ö–¶–ò–ò
        async function loadStudentGrades() {
            const response = await fetch('/api/student_grades');
            const grades = await response.json();
            document.getElementById('studentGrades').innerHTML = grades.map(g => `
                <div class="grade-item">
                    <span>${g.date} | ${g.discipline} | ${g.ktp}</span>
                    <span class="grade-mark ${g.grade === -1 ? 'n' : g.grade < 3 ? 'fail' : 'pass'}">${g.grade_str}</span>
                </div>
            `).join('');
        }

        async function loadStudentTeachers() {
            const response = await fetch('/api/student_teachers');
            const teachers = await response.json();
            document.getElementById('studentTeachers').innerHTML = 
                teachers.map(t => `<div class="list-item">${t.full_name} (${t.tokens} üí∞)</div>`).join('');
        }

        async function loadStudentTokens() {
            const response = await fetch('/api/student_tokens');
            const tokens = await response.json();
            document.getElementById('studentTokens').innerHTML = 
                tokens.map(t => `<div class="token-balance">${t.full_name}: ${t.tokens} üí∞</div>`).join('');
        }

        async function loadStudentPractices() {
            const response = await fetch('/api/student_practices');
            const practices = await response.json();
            document.getElementById('studentPractices').innerHTML = practices.map(p => `
                <div class="list-item">
                    <strong>${p.name}</strong><br>
                    –°–¥–∞–Ω–æ: ${p.completed}/${p.required} –ø—Ä–∞–∫—Ç–∏–∫
                    <div class="progress-bar"><div class="progress-fill" style="width: ${p.percentage}%"></div></div>
                    <span>${p.status}</span>
                </div>
            `).join('');
        }

        async function loadShopRewards() {
            const response = await fetch('/api/shop_rewards');
            const rewards = await response.json();
            document.getElementById('shopRewards').innerHTML = rewards.map(r => `
                <div class="list-item">
                    <strong>${r.name}</strong> (${r.discipline})<br>
                    ${r.description} | ${r.price} üí∞<br>
                    <small>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å: ${r.teacher}</small>
                    ${r.can_buy ? `<button class="btn student" onclick="buyReward(${r.id})">–ö—É–ø–∏—Ç—å</button>` : 
                    `<span style="color:red">(–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ üí∞)</span>`}
                </div>
            `).join('');
        }

        async function buyReward(id) {
            try {
                await fetch(`/api/buy_reward/${id}`, { method: 'POST' });
                showMessage('–ù–∞–≥—Ä–∞–¥–∞ –∫—É–ø–ª–µ–Ω–∞!', 'success');
                refreshData();
            } catch(e) {
                showMessage('–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏', 'error');
            }
        }

        async function exportGrades() {
            try {
                const response = await fetch('/api/export_grades');
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'grades.xlsx';
                a.click();
            } catch(e) {
                showMessage('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞', 'error');
            }
        }

        function downloadTemplate(type) {
            // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞
            window.open(`/api/template_${type}`);
        }

        function showMessage(text, type) {
            const msg = document.createElement('div');
            msg.className = `list-item ${type}`;
            msg.textContent = text;
            document.querySelector('.active')?.appendChild(msg);
            setTimeout(() => msg.remove(), 3000);
        }

        // –ó–∞–ø—É—Å–∫
        init();
    </script>
</body>
</html>