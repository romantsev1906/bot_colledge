# Telegram Mini App - Веб-приложение для бота

## Описание

Веб-приложение (мини-приложение) для Telegram бота, которое предоставляет веб-интерфейс для всех функций бота. Приложение поддерживает темную и светлую темы, дашборды с графиками, экспорт отчетов в Excel с логотипом.

## Функциональность

### Для всех ролей:
- Автоматическая авторизация по Telegram ID
- Ручной ввод ID при необходимости
- Переключение темы (темная/светлая)
- Адаптивный дизайн

### Для студентов:
- Просмотр оценок
- Просмотр преподавателей и жетончиков
- Магазин наград
- Информация о практиках
- Экспорт оценок в Excel с логотипом
- График средних баллов по дисциплинам

### Для преподавателей:
- Выставление оценок через веб-интерфейс
- Просмотр дисциплин, групп, студентов
- Просмотр КТП
- Создание ведомостей в Excel с логотипом
- Статистика и графики распределения оценок

### Для администраторов:
- Просмотр статистики системы
- Управление преподавателями и студентами
- Графики распределения по ролям

## Установка и настройка

### 1. Установка зависимостей

```bash
pip install -r requirements.txt
```

### 2. Настройка подключения к БД

Откройте файл `web_app.py` и настройте `DB_CONFIG`:

#### Для SQLite (локальная БД):
```python
DB_CONFIG = {
    'type': 'sqlite',
    'sqlite_path': 'students.db'
}
```

#### Для PostgreSQL (удаленная БД):
```python
DB_CONFIG = {
    'type': 'postgresql',
    'host': 'your-server.com',
    'port': 5432,
    'database': 'students_db',
    'user': 'your_user',
    'password': 'your_password'
}
```

#### Для MySQL (удаленная БД):
```python
DB_CONFIG = {
    'type': 'mysql',
    'host': 'your-server.com',
    'port': 3306,
    'database': 'students_db',
    'user': 'your_user',
    'password': 'your_password'
}
```

**Важно:** Для PostgreSQL и MySQL раскомментируйте соответствующий код в функции `get_db_connection()`.

### 3. Добавление логотипа

Поместите файл `logo.png` в папку `static/`. Логотип будет отображаться:
- На главной странице авторизации
- В навигационной панели
- В экспортируемых Excel файлах

### 4. Создание необходимых директорий

```bash
mkdir -p templates/student templates/teacher templates/admin
mkdir -p static/css static/js
mkdir temp
```

### 5. Запуск приложения

```bash
python web_app.py
```

Приложение будет доступно по адресу: `http://localhost:5000`

## Синхронизация с ботом

### Вариант 1: Общая БД на сервере

Если бот и веб-приложение используют одну и ту же БД на удаленном сервере:

1. Настройте `DB_CONFIG` в `web_app.py` для подключения к удаленной БД
2. В `bot_main.py` измените подключение к БД:

```python
# Для PostgreSQL
import psycopg2
conn = psycopg2.connect(
    host='your-server.com',
    port=5432,
    database='students_db',
    user='your_user',
    password='your_password'
)

# Для MySQL
import pymysql
conn = pymysql.connect(
    host='your-server.com',
    port=3306,
    database='students_db',
    user='your_user',
    password='your_password'
)
```

### Вариант 2: Репликация БД

Если бот использует локальную SQLite, а веб-приложение - удаленную БД:

1. Настройте периодическую синхронизацию данных между БД
2. Используйте скрипт синхронизации для переноса данных

### Вариант 3: API для синхронизации

Создайте API endpoints в боте для синхронизации данных с веб-приложением.

## Настройка Telegram Mini App

1. Создайте бота через @BotFather
2. Используйте команду `/newapp` для создания мини-приложения
3. Укажите URL вашего веб-приложения (например: `https://your-domain.com`)
4. Настройте домен в настройках бота

## Структура проекта

```
.
├── web_app.py              # Основное Flask приложение
├── bot_main.py             # Telegram бот
├── requirements.txt        # Зависимости Python
├── templates/              # HTML шаблоны
│   ├── index.html         # Страница авторизации
│   ├── base.html          # Базовый шаблон
│   ├── student/
│   │   └── dashboard.html
│   ├── teacher/
│   │   └── dashboard.html
│   └── admin/
│       └── dashboard.html
├── static/                 # Статические файлы
│   ├── css/
│   │   └── main.css       # Стили с поддержкой тем
│   ├── js/
│   │   ├── auth.js        # Авторизация
│   │   ├── common.js      # Общие функции
│   │   ├── student.js     # Функции студента
│   │   ├── teacher.js     # Функции преподавателя
│   │   └── admin.js       # Функции администратора
│   └── logo.png           # Логотип (добавьте свой)
└── temp/                   # Временные файлы (Excel отчеты)
```

## Особенности

### Переключение темы

Тема сохраняется в `localStorage` и применяется автоматически при следующем посещении.

### Экспорт в Excel

Все отчеты экспортируются в Excel с:
- Логотипом в верхней части
- Форматированными заголовками
- Автоматической настройкой ширины столбцов

### Автоматическая авторизация

При открытии через Telegram Mini App:
1. Приложение автоматически получает ID пользователя из Telegram
2. Проверяет пользователя в БД
3. Перенаправляет на соответствующий дашборд

Если авторизация не удалась, показывается форма для ручного ввода ID.

## Развертывание на сервере

### Использование Gunicorn (рекомендуется)

```bash
pip install gunicorn
gunicorn -w 4 -b 0.0.0.0:5000 web_app:app
```

### Использование Nginx как reverse proxy

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### Использование SSL (HTTPS)

Для Telegram Mini App требуется HTTPS. Используйте Let's Encrypt:

```bash
certbot --nginx -d your-domain.com
```

## Решение проблем

### Ошибка подключения к БД

- Проверьте настройки `DB_CONFIG`
- Убедитесь, что сервер БД доступен
- Проверьте права доступа пользователя БД

### Логотип не отображается

- Убедитесь, что файл `logo.png` находится в папке `static/`
- Проверьте права доступа к файлу
- Проверьте путь в HTML шаблонах

### Ошибки авторизации

- Проверьте, что пользователь существует в БД
- Убедитесь, что сессии работают корректно
- Проверьте настройки `app.secret_key`

## Поддержка

При возникновении проблем проверьте:
1. Логи приложения
2. Консоль браузера (F12)
3. Настройки БД
4. Права доступа к файлам

